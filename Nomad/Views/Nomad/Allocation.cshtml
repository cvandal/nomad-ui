@model Nomad.Models.Allocation

<div class="row spacer">
    <div class="col-md-6">
        <div class="row spacer">
            <div class="col-md-6">
                <h4>Allocation Properties</h4>

                <ul class="list-group">
                    <li class="list-group-item"><strong>ID</strong>: @Model.ID</li>
                    <li class="list-group-item"><strong>Name</strong>: @Model.Name</li>
                    <li class="list-group-item"><strong>Job ID</strong>:&nbsp;<a href="/job?id=@Model.JobID">@Model.JobID</a></li>
                    <li class="list-group-item"><strong>Evaluation ID</strong>:&nbsp;<a href="/evaluation?id=@Model.EvalID">@Model.EvalID</a></li>
                    <li class="list-group-item"><strong>Node ID</strong>:&nbsp;<a href="/client?id=@Model.NodeID">@Model.NodeID</a></li>
                    <li class="list-group-item"><strong>Desired Status</strong>: @Model.DesiredStatus</li>
                    <li class="list-group-item"><strong>Client Status</strong>: @Model.ClientStatus</li>
                    <li class="list-group-item"><strong>Create Time</strong>: @Model.CreateDateTime</li>
                </ul>
            </div>

            <div class="col-md-6">
                <h4>Resources</h4>

                <ul class="list-group">
                    <li class="list-group-item"><strong>CPU (MHz)</strong>: @Model.Resources.CPU</li>
                    <li class="list-group-item"><strong>Memory (MB)</strong>: @Model.Resources.MemoryMB</li>
                    <li class="list-group-item"><strong>Disk (MB)</strong>: @Model.Resources.DiskMB</li>
                    @foreach (var network in Model.Resources.Networks)
                    {
                        <li class="list-group-item"><strong>Network (Mbps)</strong>: @network.MBits</li>
                        <li class="list-group-item"><strong>Device</strong>: @network.Device</li>
                        <li class="list-group-item"><strong>IP</strong>: @network.IP</li>
                        @foreach (var port in network.DynamicPorts)
                        {
                            <li class="list-group-item"><strong>Port</strong>: @port.Value</li>
                        }
                    }
                </ul>
            </div>
        </div>

        <div id="charts"></div>

        <script type="text/jsx">
            var App = React.createClass({
                getInitialState: function() {
                    return {
                        client: null
                    }
                },
                
                componentDidMount: function() {
                    const makeRequest = () => axios.get("/api/allocation/stats?client=@Model.Resources.Networks.FirstOrDefault().IP&id=@Model.ID").then(({ data }) => this.setState({ client: data }));
                    
                    this.serverRequest = makeRequest();
                    
                    this.poll = setInterval(() => {
                        this.serverRequest = makeRequest();
                    }, 1000) // Poll every 1 seconds
                },
                
                componentWillUnmount: function() {
                    this.serverRequest.abort();
                    clearInterval(this.poll)
                },
                
                render: function() {
                    const { client } = this.state;
                    
                    if (client === null) {
                        return null
                    }
                    
                    var idleCpu = (100 - client.resourceUsage.cpuStats.percent);
                    var activeCpu = client.resourceUsage.cpuStats.percent;
                    var availableMem = (@Model.Resources.MemoryMB - (client.resourceUsage.memoryStats.maxUsage / 1024) / 1024);
                    var consumedMem = ((client.resourceUsage.memoryStats.maxUsage / 1024) / 1024);
                    
                    return (
                        <div className="row spacer">
                            <div className="col-md-6">
                                <h4>CPU Utilisation</h4>
                                <reactChartjs2.Doughnut
                                    data={{
                                        labels: ["Idle %", "Active %" ],
                                        datasets: [{
                                            data: [idleCpu, activeCpu],
                                            backgroundColor: ['#1fb58f', '#eab126' ],
                                            hoverBackgroundColor: ['#1fb58f', '#eab126' ],
                                            borderColor: ['#1e1e1e', '#1e1e1e' ]
                                        }]
                                    }}
                                    options={{
                                        cutoutPercentage: 75,
                                        legend: {
                                            labels: {
                                                fontColor: "#fff"
                                            }
                                        }
                                    }}
                                    height={200}
                                />
                            </div>

                            <div className="col-md-6">
                                <h4>Memory Utilisation</h4>
                                    <reactChartjs2.Doughnut
                                    data={{
                                        labels: ["Available MB", "Consumed MB"],
                                        datasets: [{
                                            data: [availableMem, consumedMem],
                                            backgroundColor: ['#1fb58f', '#eab126'],
                                            hoverBackgroundColor: ['#1fb58f', '#eab126'],
                                            borderColor: ['#1e1e1e', '#1e1e1e']
                                        }]
                                    }}
                                    options={{
                                        cutoutPercentage: 75,
                                        legend: {
                                            labels: {
                                                fontColor: "#fff"
                                            }
                                        }
                                    }}
                                    height={200}
                                />
                            </div>
                        </div>
                    )
                }
            });

            ReactDOM.render(<App />, document.getElementById("charts"));
        </script>
    </div>

    <div class="col-md-6">
        <h4>Logs</h4>

        <div class="row">
            <div class="col-md-4" style="height: 800px;max-height: 800px !important; overflow: auto;">
                <ul class="list-group">
                    <li class="list-group-item">/alloc</li>
                    <li class="list-group-item list-group-item-condensed">
                        <ul class="list-group">
                            <li class="list-group-item">/logs</li>
                            <li class="list-group-item list-group-item-condensed">
                                <ul class="list-group logs">
                                    @foreach (var log in Model.Logs.OrderBy(l => l.Name))
                                    {
                                        <li class="list-group-item log-name"><a href="#">@log.Name</a></li>
                                    }
                                </ul>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>

            <div class="col-md-8" style="max-height: 800px !important; overflow: auto;">
                <pre style="white-space: pre-wrap;"><code class="log-content"></code></pre>
            </div>
        </div>

        <script>
            $('.log-name').on("click", function () {
                $('.log-name').removeClass('active');
                $(this).addClass('active');

                $('.log-content').html('<img src="images/loading.gif" alt="Loading..." />');

                $.get("/allocation/log?client=@Model.Resources.Networks.FirstOrDefault().IP&id=@Model.ID&log=" + $(this).text(), function (content) {
                    if (content) {
                        $('.log-content').html(content);
                    }
                    else {
                        $('.log-content').html("¯\\_(ツ)_/¯");
                    }
                });
            });
        </script>
    </div>
</div>

<div class="row spacer">
    <div class="col-md-12">
        <h4>Task Events</h4>

        <table class="table table-hover">
            <thead>
                <tr class="row">
                    <th class="col">Name</th>
                    <th class="col">Type</th>
                    <th class="col">Message</th>
                    <th class="col">Time</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var key in Model.TaskStates.Keys)
                {
                    @foreach (var @event in Model.TaskStates[key].Events.OrderByDescending(t => t.Time))
                    {
                        <tr class="row">
                            <td class="col">@Model.Name</td>
                            <td class="col">@(@event.Type)</td>
                            <td class="col">
                                @(@event.DownloadError)
                                @(@event.DriverError)
                                @(@event.DriverMessage)
                                @(@event.KillError)
                                @(@event.KillReason)
                                @(@event.Message)
                                @(@event.RestartReason)
                                @(@event.SetupError)
                                @(@event.TaskSignalReason)
                                @(@event.ValidationError)
                                @(@event.VaultError)
                            </td>
                            <td class="col">@(@event.DateTime)</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <h4>Raw JSON <a class="material-icons" href="#json" data-toggle="collapse">keyboard_arrow_down</a></h4>

        <div id="json" class="collapse">
            <pre><code>@ViewData["Json"]</code></pre>
        </div>
    </div>
</div>
